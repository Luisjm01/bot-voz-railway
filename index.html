<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ğŸ¤– Bot de Voz</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– Bot de Voz</h1>
    <p>Presiona el botÃ³n y habla. El bot responderÃ¡ con voz.</p>
    <select id="voz">
      <option value="mi_voz">ğŸ—£ï¸ Mi voz clonada</option>
    </select>
    <button id="btnHablar">ğŸ™ï¸ Hablar</button>
    <p class="status" id="estado">Listo para hablar</p>
    <h3>Respuesta del bot:</h3>
    <audio id="audioRespuesta" controls></audio>
  </div>
  <script>
    const btn = document.getElementById("btnHablar");
    const estado = document.getElementById("estado");
    const audio = document.getElementById("audioRespuesta");
    let grabando = false;
    let mediaRecorder;
    let audioChunks = [];

    btn.addEventListener("click", async () => {
      if (!grabando) {
        grabando = true;
        btn.textContent = "â¹ï¸ Detener";
        estado.textContent = "ğŸ™ï¸ Grabando... habla ahora";

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.start();

        mediaRecorder.addEventListener("dataavailable", event => {
          audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", async () => {
          estado.textContent = "â³ Procesando... por favor espera â³";

          const audioBlob = new Blob(audioChunks, { type: "audio/mp3" });
          const formData = new FormData();
          formData.append("audio", audioBlob, "grabacion.mp3");

          const respuesta = await fetch("/api/audio", {
            method: "POST",
            body: formData,
          });

          const data = await respuesta.json();
          if (data.audioUrl) {
            audio.src = data.audioUrl;
            estado.textContent = "âœ… Respuesta generada";
          } else {
            estado.textContent = "âŒ Error al procesar el audio.";
          }

          grabando = false;
          btn.textContent = "ğŸ™ï¸ Hablar";
          audioChunks = [];
        });

      } else {
        grabando = false;
        mediaRecorder.stop();
        btn.textContent = "ğŸ™ï¸ Hablar";
      }
    });
  </script>
</body>
</html>