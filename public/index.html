
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bot de Voz</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <h1>ğŸ¤– Bot de Voz</h1>
  <p>Presiona el botÃ³n para grabar. Puedes detener la grabaciÃ³n manualmente.</p>
  <select id="voz">
    <option value="hYYnmijq0aL078R8FAKj1">ğŸ§” Mi voz clonada</option>
  </select>
  <div class="botones">
    <button id="hablar">ğŸ¤ Hablar</button>
    <button id="detener">âœ‹ Detener</button>
  </div>
  <p id="status">Procesando... por favor espera â³</p>
  <h3>Respuesta del bot:</h3>
  <audio id="audioRespuesta" controls></audio>
  <script>
    let mediaRecorder;
    let audioChunks = [];
    const status = document.getElementById('status');
    const audioRespuesta = document.getElementById('audioRespuesta');

    document.getElementById("hablar").onclick = async () => {
      audioChunks = []; // <-- LIMPIA BUFFER
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.start();

      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioChunks = []; // <-- LIMPIA BUFFER DESPUÃ‰S DE USO
        const formData = new FormData();
        formData.append('audio', audioBlob);
        formData.append('voz', document.getElementById("voz").value);

        status.textContent = "Procesando... por favor espera â³";

        try {
          const response = await fetch('/api/audio', { method: 'POST', body: formData });
          const data = await response.json();
          if (data.audioUrl) {
            audioRespuesta.src = data.audioUrl;
            audioRespuesta.play();
          } else {
            alert("Error al procesar el audio.");
          }
        } catch (error) {
          alert("Error al procesar el audio.");
        }
      };
    };

    document.getElementById("detener").onclick = () => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
      }
    };
  </script>
</body>
</html>
