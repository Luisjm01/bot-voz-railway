<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bot de Voz</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– Bot de Voz</h1>

    <p>Presiona el botÃ³n y habla. El bot responderÃ¡ con voz.</p>

    <select id="voz">
      <option value="hYYNmijq0aL07R8FAKj1">ğŸ§” Mi voz clonada</option>
      <option value="EXAVITQu4vr4xnSDxMaL">ğŸ™ï¸ Antoni (voz masculina)</option>
    </select>

    <button id="grabar">ğŸ¤ Hablar</button>

    <p id="estado"></p>

    <h3>Respuesta del bot:</h3>
    <audio id="audioRespuesta" controls></audio>
  </div>

  <script>
    const grabarBtn = document.getElementById("grabar");
    const estado = document.getElementById("estado");
    const audioRespuesta = document.getElementById("audioRespuesta");
    const voz = document.getElementById("voz");

    let mediaRecorder;
    let audioChunks = [];

    grabarBtn.onclick = async () => {
      if (!navigator.mediaDevices) {
        alert("Este navegador no permite grabaciÃ³n de audio.");
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];

      mediaRecorder.ondataavailable = event => {
        if (event.data.size > 0) {
          audioChunks.push(event.data);
        }
      };

      mediaRecorder.onstop = async () => {
        estado.textContent = "Procesando... por favor espera â³";

        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append("audio", audioBlob);
        formData.append("voz", voz.value);

        try {
          const res = await fetch("/api/audio", {
            method: "POST",
            body: formData,
          });

          if (!res.ok) throw new Error("Fallo al enviar el audio");

          const data = await res.json();
          audioRespuesta.src = data.audioUrl;
          audioRespuesta.play();
          estado.textContent = "";
        } catch (err) {
          alert("Error al procesar el audio.");
          console.error(err);
          estado.textContent = "";
        }
      };

      mediaRecorder.start();
      estado.textContent = "ğŸ™ï¸ Grabando... habla ahora";

      setTimeout(() => {
        mediaRecorder.stop();
        estado.textContent = "â³ Procesando...";
      }, 4000);
    };
  </script>
</body>
</html>